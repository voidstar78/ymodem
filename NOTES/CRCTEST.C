#include <stdio.h>
#include <stdint.h>
#include <stddef.h>

uint16_t calculate_xmodem_crc(const unsigned char* data, size_t len) 
{
    uint16_t crc = 0x0000; // Initial value (other CRC might start with 0xFFFF)
    int16_t signed_ref;
    uint8_t i;

    while (len--) {
        // XOR with the current byte shifted into the high byte
        printf("%c(%d) %X ", *data, *data, crc);
        printf(" ^ (%X)", (uint16_t)(*data) << 8);
        crc ^= (uint16_t)(*data++) << 8; 
        signed_ref = crc;
        printf("= %X(%d)\n", crc, signed_ref);
        for (i = 0; i < 8; ++i) {
            printf("  %d %X  --> ", i, crc);
            if (crc & 0x8000) {
                // If the most significant bit is set, shift left 
                // and XOR with the polynomial
                crc = (crc << 1) ^ 0x1021;  // The XMODEM polynomial
            } else {
                // Otherwise, just shift left
                crc <<= 1;
            }
            signed_ref = crc;
            printf("%X(%d)\n", crc, signed_ref);
        }
    }

    return crc;  // The result is used directly without final XOR
}

int main()
{
    uint16_t crc_result;
    int16_t unsigned_ref;
    char test_str[128] = {
	  0x01, 0x02, 0x04, 0x05, 0x07, 0x0B, 0x0C, 0x0E, 0x0F, 0x11, 0x12, 0x16, 0x17, 0x18, 0x19, 0x31, 
	  0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x20, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
	  0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,                
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	};
        
    crc_result = calculate_xmodem_crc(test_str, 128);
    unsigned_ref = crc_result;
    printf("%X(%d)", crc_result, unsigned_ref);

    return 0;
}
